FROM --platform=i386 i386/debian:bookworm

ARG DEBIAN_FRONTEND=noninteractive

# Base system + tools for the quest
RUN apt-get clean && apt-get update && apt-get -y upgrade && \
    apt-get -y install \
        apt-utils gcc python3 vim unzip ruby nodejs fakeroot dbus base \
        whiptail hexedit patch wamerican ucf manpages file luajit make \
        lua5.4 dialog curl less cowsay netcat-openbsd \
        nano iproute2

# User and passwords (intentionally weak for the quest)
RUN useradd -m user && echo "user:password" | chpasswd && \
    echo 'root:password' | chpasswd

# Drop in example files (optional content for the quest)
COPY --chown=user:user ./examples /home/user/examples
RUN chmod -R +x /home/user/examples/lua

# --- PrivEsc hooks ---------------------------------------------------------

# 1) Make /etc/shadow readable (intentionally insecure, for the challenge)
RUN chmod 0644 /etc/shadow

# 2) SUID bits on nice and nano (intentionally insecure)
RUN chown root:root /usr/bin/nice /bin/nano && \
    chmod u+s /usr/bin/nice /bin/nano

# --- Environment / defaults ------------------------------------------------
WORKDIR /home/user/
ENV HOME="/home/user" TERM="xterm" USER="user" SHELL="/bin/bash" EDITOR="vim" LANG="en_US.UTF-8" LC_ALL="C"

# Default to a shell
CMD ["/bin/bash"]
